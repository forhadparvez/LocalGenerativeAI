@{
    ViewData["Title"] = "AI Chat";
}

<div class="container mt-4">
    <h2>Local AI Assistant</h2>

    <!-- Document Upload Section -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Add Documents to Knowledge Base</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-9">
                    <textarea id="documentInput" class="form-control" rows="4"
                              placeholder="Paste your document text here..."></textarea>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="documentId" class="form-label">Document ID (optional)</label>
                        <input type="text" id="documentId" class="form-control"
                               placeholder="e.g., doc1" />
                    </div>
                    <button class="btn btn-success w-100" id="addDocBtn">Add Document</button>
                    <div id="docStatus" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Section -->
    <!-- Chat Section -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Chat</h5>
        </div>
        <div class="card-body">
            <div id="chatBox" class="border rounded p-3 mb-3"
                style="height:400px; overflow-y:auto; background:#f8f9fa;">
            </div>

            <!-- Webpage URL Input -->
            <div class="mb-2">
                <label class="form-label">Optional Webpage URL</label>
                <input type="text" id="webUrlInput" class="form-control"
                    placeholder="https://example.com/article" />
            </div>

            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="useWebSearch">
                <label class="form-check-label" for="useWebSearch">
                    Enable Web Search
                </label>
            </div>

            <div class="input-group">
                <input type="text" id="userInput" class="form-control"
                    placeholder="Type your message..." />
                <button class="btn btn-primary" id="sendBtn">Send</button>
            </div>
        </div>
    </div>
</div>

@section Styles {

}

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // Add Document Function
    $("#addDocBtn").click(function () {
        var content = $("#documentInput").val();
        var docId = $("#documentId").val();

        if (!content) {
            $("#docStatus").html("<div class='alert alert-warning'>Please enter document text</div>");
            return;
        }

        var docData = { content: content };
        if (docId) {
            docData.document_id = docId;
        }

        $.ajax({
            url: "http://localhost:8000/add-document",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(docData),
            success: function (res) {
                if (res.status === "success") {
                    $("#docStatus").html(
                        "<div class='alert alert-success'>" +
                        "✓ Document added! (" + res.chunks_added + " chunks)" +
                        "</div>"
                    );
                    $("#documentInput").val("");
                    $("#documentId").val("");
                }
                else {
                    $("#docStatus").html("<div class='alert alert-danger'>Error adding document</div>");
                }
            },
            error: function () {
                $("#docStatus").html("<div class='alert alert-danger'>Cannot reach server</div>");
            }
        });
    });

    // Chat Function
    // Chat Function
    $("#sendBtn").click(function () {

        var message = $("#userInput").val();
        var useWeb = $("#useWebSearch").is(":checked");
        var webUrl = $("#webUrlInput").val();

        if (!message) return;

        // Add user message
        $("#chatBox").append(
            "<div class='text-end mb-2'>" +
            "<div class='p-2 rounded bg-secondary text-white user-bubble'>" +
            message +
            "</div></div>"
        );

        $("#userInput").val("");

        var loadingId = "loading_" + Date.now();

        $("#chatBox").append(
            "<div class='text-start mb-2' id='" + loadingId + "'>" +
            "<div class='p-2 rounded bg-light border ai-bubble'>" +
            "Thinking..." +
            "</div></div>"
        );

        $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);

        $.ajax({
            url: "http://localhost:8000/chat",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                message: message,
                use_web: useWeb,
                web_url: webUrl ? webUrl : null
            }),
            success: function (res) {

                $("#" + loadingId).remove();

                if (res.response) {

                    var badges = "";

                    if (res.internal_context_used) {
                        badges += "<small class='text-success'>[Internal]</small> ";
                    }

                    if (res.web_used) {
                        badges += "<small class='text-primary'>[Web Search]</small> ";
                    }

                    if (res.webpage_used) {
                        badges += "<small class='text-warning'>[Webpage]</small>";
                    }

                    $("#chatBox").append(
                        "<div class='text-start mb-2'>" +
                        "<div class='p-2 rounded bg-light border ai-bubble'>" +
                        res.response + "<br/>" + badges +
                        "</div></div>"
                    );

                    $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
                }
                else {
                    alert("AI Error");
                }
            },
            error: function () {
                $("#" + loadingId).remove();
                alert("Cannot reach AI server");
            }
        });
    });

    // Allow Enter key to send message
    $("#userInput").keypress(function (e) {
        if (e.which == 13) {
            $("#sendBtn").click();
        }
    });
</script>
}
